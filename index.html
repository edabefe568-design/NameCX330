<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D éº»å°† - æœ¬åœ°æ— æ•Œç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #2e8b57; font-family: "Microsoft YaHei", sans-serif; }
        #info {
            position: absolute; top: 10px; left: 10px; color: white;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px;
            pointer-events: none; user-select: none; z-index: 10;
            border: 1px solid rgba(255,255,255,0.2); width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 20px; font-weight: bold; 
            text-align: center; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;
            pointer-events: none; z-index: 20;
        }
        #debug-log {
            position: absolute; top: 200px; left: 10px; color: #ff5555; 
            font-size: 14px; background: rgba(0,0,0,0.8); padding: 10px;
            max-width: 300px; z-index: 100; pointer-events: none;
            display: none; white-space: pre-wrap;
        }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; }
        .input_video { display: none; }
    </style>
    
    <script src="./three.min.js"></script>
    
    <script src="./camera_utils.js"></script>
    <script src="./control_utils.js"></script>
    <script src="./drawing_utils.js"></script>
    <script src="./hands.js"></script>
</head>
<body>

<div id="debug-log"></div>

<div id="info">
    <h3 style="margin:0 0 10px 0;">ğŸ€„ï¸ å››äººéº»å°† (æœ¬åœ°éƒ¨ç½²ç‰ˆ)</h3>
    <p><b>çŠ¶æ€:</b> <span id="status_text">ç³»ç»Ÿåˆå§‹åŒ–...</span></p>
    <hr style="border-color: #555;">
    <div style="font-size: 14px; line-height: 1.8;">
        <div><span class="status-dot" id="dot-grab" style="background:#555"></span> <b>æåˆ (ğŸ‘Œ)</b>: æŠ“å– / å‡ºç‰Œ</div>
        <div><span class="status-dot" id="dot-view" style="background:#555"></span> <b>å¼ å¼€ (âœ‹)</b>: æ—‹è½¬è§†è§’</div>
    </div>
</div>

<div id="loading">
    æ­£åœ¨åŠ è½½æ¨¡å‹æ•°æ®...<br>
    <span style="font-size:14px; font-weight:normal; color:#ddd">åŸºç¡€æ–‡ä»¶å·²ä»æœ¬åœ°åŠ è½½</span>
</div>
<video class="input_video" playsinline webkit-playsinline></video>

<script>
// --- é”™è¯¯æ—¥å¿—ç³»ç»Ÿ ---
function logError(msg) {
    const logBox = document.getElementById('debug-log');
    logBox.style.display = 'block';
    logBox.innerText += "âŒ " + msg + "\n";
    document.getElementById('status_text').innerText = "åŠ è½½å¤±è´¥";
    document.getElementById('loading').innerHTML = "âš ï¸ é”™è¯¯<br><span style='font-size:14px'>è¯·æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ æ‰€æœ‰JSæ–‡ä»¶</span>";
}
window.onerror = function(msg) { logError(msg); };

// --- æ£€æŸ¥æœ¬åœ°æ–‡ä»¶æ˜¯å¦å°±ä½ ---
window.onload = function() {
    if (typeof THREE === 'undefined') {
        logError("æœªæ‰¾åˆ° three.min.jsï¼è¯·ç¡®è®¤å·²ä¸Šä¼ è¯¥æ–‡ä»¶åˆ°ä»“åº“ã€‚");
    } else if (typeof Hands === 'undefined') {
        logError("æœªæ‰¾åˆ° hands.jsï¼è¯·ç¡®è®¤å·²ä¸Šä¼ è¯¥æ–‡ä»¶åˆ°ä»“åº“ã€‚");
    }
};

// --- èµ„æºé…ç½® (æ³¨æ„è¿™é‡Œ) ---
const config = {
    // è¿™é‡Œçš„ .wasm æ–‡ä»¶æ¯”è¾ƒå¤§ä¸”ç‰¹æ®Šï¼Œæˆ‘ä»¬ä¾ç„¶è®©å®ƒå»å›½å†…é•œåƒä¸‹è½½
    // ä½†å› ä¸º hands.js å·²ç»æ˜¯æœ¬åœ°çš„äº†ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç° "Hands is not defined" é”™è¯¯
    locateFile: (file) => {
        return `https://unpkg.npmmirror.com/@mediapipe/hands@0.4.1646424915/${file}`;
    }
};

// --- æ¸¸æˆé€»è¾‘ (ä¿æŒä¸å˜) ---
const TILE_PAINTER={createTexture:function(e,t){const a=document.createElement("canvas");a.width=256,a.height=320;const r=a.getContext("2d");if(r.fillStyle="#ffffff",r.fillRect(0,0,256,320),r.strokeStyle="#e8e8e8",r.lineWidth=2,r.strokeRect(4,4,248,312),r.textAlign="center",r.textBaseline="middle","é¥¼"===e)this.drawDots(r,t);else if("æ¡"===e)this.drawBamboos(r,t);else if("ä¸‡"===e)this.drawWan(r,t);else if("å­—"===e)this.drawHonors(r,t);const n=new THREE.CanvasTexture(a);return n.colorSpace=THREE.SRGBColorSpace,n.flipY=!0,n},colors:{R:"#d60000",B:"#0044bb",G:"#008800"},drawDots:function(e,t){const{R:a,B:r,G:n}=this.colors,o=(t,a,r,n,o)=>{e.beginPath(),e.arc(t,a,r,0,2*Math.PI),e.fillStyle=n,e.fill(),o&&(e.beginPath(),e.arc(t,a,.4*r,0,2*Math.PI),e.fillStyle=o,e.fill()),e.beginPath(),e.arc(t,a,.75*r,0,2*Math.PI),e.strokeStyle="rgba(255,255,255,0.4)",e.lineWidth=3,e.stroke()};if(1===t){e.beginPath(),e.arc(128,160,70,0,2*Math.PI),e.fillStyle=n,e.fill(),e.beginPath(),e.arc(128,160,45,0,2*Math.PI),e.fillStyle=a,e.fill(),e.strokeStyle="white",e.lineWidth=4;for(let t=0;t<12;t++){let a=t/12*Math.PI*2;e.beginPath(),e.moveTo(128,160),e.lineTo(128+70*Math.cos(a),160+70*Math.sin(a)),e.stroke()}return}({2:[[128,80,r,a],[128,240,n,a]],3:[[60,60,r,a],[128,160,a,a],[196,260,n,a]],4:[[70,80,r,n],[186,80,r,n],[70,240,n,r],[186,240,n,r]],5:[[70,70,r,n],[186,70,r,n],[128,160,a,a],[70,250,n,r],[186,250,n,r]],6:[[70,70,n,a],[186,70,n,a],[70,160,a,a],[186,160,a,a],[70,250,a,a],[186,250,a,a]],7:[[60,65,n,r],[128,85,n,r],[196,105,n,r],[70,180,a,a],[186,180,a,a],[70,260,a,a],[186,260,a,a]],8:[[70,60,r,r],[186,60,r,r],[70,126,r,r],[186,126,r,r],[70,192,r,r],[186,192,r,r],[70,260,r,r],[186,260,r,r]],9:[[60,60,r,r],[128,60,r,r],[196,60,r,r],[60,160,a,a],[128,160,a,a],[196,160,a,a],[60,260,n,n],[128,260,n,n],[196,260,n,n]]}[t]||[]).forEach((e=>o(e[0],e[1],24,e[2],e[3])))},drawBamboos:function(e,t){const{R:a,B:r,G:n}=this.colors;if(1===t)return e.fillStyle="#dcb",e.beginPath(),e.arc(128,180,40,0,2*Math.PI),e.fill(),e.font="160px Arial",e.fillStyle=n,e.fillText("ğŸ¦",128,160),void 0;const o=(t,a,r)=>{e.lineCap="round",e.lineWidth=14,e.strokeStyle=r,e.beginPath(),e.moveTo(t,a-26),e.lineTo(t,a+26),e.stroke(),e.strokeStyle="white",e.lineWidth=3,e.beginPath(),e.moveTo(t-6,a),e.lineTo(t+6,a),e.stroke()};({2:[[128,80,r],[128,240,n]],3:[[128,60,r],[70,240,n],[186,240,n]],4:[[70,80,r],[186,80,n],[70,240,n],[186,240,r]],5:[[70,70,n],[186,70,r],[128,160,a],[70,250,r],[186,250,n]],6:[[70,60,n],[128,60,n],[186,60,n],[70,240,n],[128,240,n],[186,240,n]],7:[[128,60,a],[70,140,n],[128,140,r],[186,140,n],[70,240,n],[128,240,r],[186,240,n]],8:[[70,60,n],[128,60,n],[186,60,n],[70,160,a],[186,160,a],[70,260,r],[128,260,r],[186,260,r]],9:[[70,60,a],[128,60,r],[186,60,n],[70,160,a],[128,160,r],[186,160,n],[70,260,a],[128,260,r],[186,260,n]]}[t]||{2:[[128,80,r],[128,240,n]]}[2]).forEach((e=>o(e[0],e[1],e[2])))},drawWan:function(e,t){const{R:a,B:r}=this.colors,n=["","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"];e.font='bold 90px "Microsoft YaHei"',e.fillStyle=r,e.fillText(n[t],128,90),e.font='bold 120px "Microsoft YaHei"',e.fillStyle=a,e.fillText("è¬",128,230)},drawHonors:function(e,t){const{R:a,B:r,G:n}=this.colors;if("ç™½"===t)return e.strokeStyle=r,e.lineWidth=6,e.strokeRect(45,45,166,230),e.lineWidth=3,e.strokeRect(55,55,146,210),void 0;let o=r;"ä¸­"===t&&(o=a),"å‘"===t&&(o=n),e.font='bold 140px "Microsoft YaHei"',e.fillStyle=o,e.fillText(t,128,160)}};
let camera,scene,renderer,myHand=[],opponentHands=[],raycaster,mouse,selectedTile=null,handCursor,tileGeometry=null;const TILE_W=2.2,TILE_H=3,TILE_D=1.4,BEVEL=.1,FACE_Z=TILE_D/2+BEVEL+.02;let isPinching=!1,cameraAngle=0,targetCameraAngle=0,previousPalmX=null;
function init3D(){if(typeof THREE==='undefined') return; scene=new THREE.Scene,scene.background=new THREE.Color(3049303),scene.fog=new THREE.Fog(3049303,20,100),camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),updateCameraPosition();const e=new THREE.AmbientLight(16777215,.6);scene.add(e);const t=new THREE.DirectionalLight(16772795,1);t.position.set(5,20,10),t.castShadow=!0,t.shadow.mapSize.set(2048,2048),scene.add(t);const a=new THREE.Mesh(new THREE.PlaneGeometry(120,120),new THREE.MeshStandardMaterial({color:3049303,roughness:.9}));a.rotation.x=-Math.PI/2,a.position.y=-2,a.receiveShadow=!0,scene.add(a);const r=new THREE.MeshStandardMaterial({color:4070151}),n=new THREE.BoxGeometry(122,2,2),o=new THREE.Mesh(n,r);o.position.set(0,-2,-60),scene.add(o);const i=new THREE.Mesh(n,r);i.position.set(0,-2,60),scene.add(i);const l=new THREE.Mesh(new THREE.BoxGeometry(2,2,120),r);l.position.set(-60,-2,0),scene.add(l);const s=new THREE.Mesh(new THREE.BoxGeometry(2,2,120),r);s.position.set(60,-2,0),scene.add(s),handCursor=new THREE.Mesh(new THREE.SphereGeometry(.35),new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:.8})),scene.add(handCursor),renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.outputEncoding=THREE.sRGBEncoding,document.body.appendChild(renderer.domElement),raycaster=new THREE.Raycaster,mouse=new THREE.Vector2,window.addEventListener("resize",(()=>{camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}));const d=new THREE.Shape,c=TILE_W,h=TILE_H,u=.3,m=-c/2,p=-h/2;d.moveTo(m,p+u),d.lineTo(m,p+h-u),d.quadraticCurveTo(m,p+h,m+u,p+h),d.lineTo(m+c-u,p+h),d.quadraticCurveTo(m+c,p+h,m+c,p+h-u),d.lineTo(m+c,p+u),d.quadraticCurveTo(m+c,p,m+c-u,p),d.lineTo(m+u,p),d.quadraticCurveTo(m,p,m,p+u),tileGeometry=new THREE.ExtrudeGeometry(d,{depth:TILE_D,bevelEnabled:!0,bevelThickness:BEVEL,bevelSize:BEVEL,bevelSegments:2}),tileGeometry.center(),initGame()}
function createTileMesh(e){const t=TILE_PAINTER.createTexture(e.type,e.val),a=new THREE.MeshStandardMaterial({color:16777208,roughness:.2}),r=new THREE.MeshStandardMaterial({color:39364,roughness:.2}),n=new THREE.MeshBasicMaterial({map:t,transparent:!0}),o=new THREE.Group,i=new THREE.Mesh(tileGeometry,a);i.castShadow=!0,i.receiveShadow=!0,o.add(i);const l=new THREE.Mesh(new THREE.BoxGeometry(TILE_W-.1,TILE_H-.1,.1),r);l.position.z=-FACE_Z,o.add(l);const s=new THREE.Mesh(new THREE.PlaneGeometry(TILE_W-.3,TILE_H-.3),n);return s.position.z=FACE_Z,s.renderOrder=1,o.add(s),o.userData={isTile:!0,data:e},i.userData=s.userData=l.userData={parentTile:o},o}
function initGame(){const e=generateTileData();for(let t=0;t<14;t++){const t=createTileMesh(e.pop());myHand.push(t),scene.add(t)}reorderTiles(),setupOpponentHandSimple(e,13,new THREE.Vector3(0,-.5,-28),0,Math.PI,"z"),setupOpponentHandSimple(e,13,new THREE.Vector3(-32,-.5,0),Math.PI/2,0,"x"),setupOpponentHandSimple(e,13,new THREE.Vector3(32,-.5,0),-Math.PI/2,0,"x")}
function setupOpponentHandSimple(e,t,a,r,n,o){const i=1*TILE_W,l=t*i;for(let s=0;s<t;s++){const t=createTileMesh(e.pop());t.rotation.set(0,r,0);const n=-l/2+i/2+s*i;"z"===o?t.position.set(a.x+n,a.y,a.z):t.position.set(a.x,a.y,a.z+n),scene.add(t),opponentHands.push(t)}}
function generateTileData(){const e=[];return["ä¸‡","æ¡","é¥¼"].forEach((t=>{for(let a=1;a<=9;a++)for(let r=0;r<4;r++)e.push({type:t,val:a})})),["ä¸œ","å—","è¥¿","åŒ—","ä¸­","å‘","ç™½"].forEach((t=>{for(let a=0;a<4;a++)e.push({type:"å­—",val:t})})),function(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}(e),e}
function reorderTiles(){const e=1.1*TILE_W,t=-(myHand.length*e)/2+e/2;myHand.forEach(((a,r)=>{a!==selectedTile&&(a.position.lerp(new THREE.Vector3(t+r*e,-.5,19),.2),a.rotation.set(-Math.PI/10,0,0))}))}
function updateCameraPosition(){cameraAngle+=.05*(targetCameraAngle-cameraAngle);const e=35;camera.position.x=e*Math.sin(cameraAngle),camera.position.z=e*Math.cos(cameraAngle)+6,camera.position.y=24,camera.lookAt(0,-3,0)}
function onResults(e){document.getElementById("loading").style.display="none",reorderTiles(),updateCameraPosition();const t=document.getElementById("dot-grab"),a=document.getElementById("dot-view"),r=document.getElementById("status_text");if(t.style.background="#555",a.style.background="#555",e.multiHandLandmarks&&e.multiHandLandmarks.length>0){const n=e.multiHandLandmarks[0],o=n[8],i=n[4],l=n[20],s=n[0];mouse.x=2*(1-o.x)-1,mouse.y=2*-o.y+1,updateCursor();const d=Math.hypot(o.x-i.x,o.y-i.y);Math.hypot(l.x-s.x,l.y-s.y);if(d<.06)isPinching=!0,previousPalmX=null,t.style.background="#0f0",r.innerText="âœŠ æŠ“å–æ¨¡å¼",handCursor.material.color.set(65280),processGrab(!0);else if(!isPinching&&Math.hypot(l.x-s.x,l.y-s.y)>.15){isPinching=!1,processGrab(!1),a.style.background="#00f",r.innerText="âœ‹ è§†è§’æ¨¡å¼",handCursor.material.color.set(34969);const e=n[9].x;null!==previousPalmX&&Math.abs(e-previousPalmX)>.003&&(targetCameraAngle+=4*((1-e)-(1-previousPalmX))),previousPalmX=e}else isPinching=!1,processGrab(!1),previousPalmX=null,r.innerText="â˜ï¸ ç§»åŠ¨å…‰æ ‡",handCursor.material.color.set(16776960)}else r.innerText="â³ å¯»æ‰¾æ‰‹åŠ¿...",previousPalmX=null;renderer.render(scene,camera)}
function updateCursor(){raycaster.setFromCamera(mouse,camera);const e=new THREE.Plane(new THREE.Vector3(0,0,1),-8),t=new THREE.Vector3;raycaster.ray.intersectPlane(e,t),t&&handCursor.position.lerp(t,.4)}
function processGrab(e){if(e){if(!selectedTile){const e=raycaster.intersectObjects(myHand,!0);if(e.length>0){let t=e[0].object;for(;t;){if(t.userData&&t.userData.isTile){selectedTile=t;break}if(t.userData&&t.userData.parentTile){selectedTile=t.userData.parentTile;break}t=t.parent}}}selectedTile&&(selectedTile.position.copy(handCursor.position),selectedTile.position.z=12,selectedTile.rotation.x=-Math.PI/6)}else selectedTile&&(selectedTile.position.y>5&&discardTile(selectedTile),selectedTile=null)}
function discardTile(e){const t=myHand.indexOf(e);t>-1&&myHand.splice(t,1),e.userData=null,e.position.set(10*Math.random()-5,5*Math.random()+5,5*-Math.random()),e.rotation.set(-Math.PI/2,0,3*Math.random()),setTimeout((()=>{const e=createTileMesh(generateTileData()[0]);scene.add(e),myHand.push(e)}),500)}

// --- å¯åŠ¨æµç¨‹ ---
async function startApp() {
    try {
        if (typeof THREE === 'undefined') throw new Error("Three.js åŠ è½½å¤±è´¥");
        
        init3D();
        
        // 1. è®¾ç½® Hands
        const hands = new Hands({locateFile: config.locateFile});
        hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        hands.onResults(onResults);
        
        // 2. å‡†å¤‡æ‘„åƒå¤´
        const video = document.getElementsByClassName('input_video')[0];
        document.getElementById('loading').innerHTML = "æ­¥éª¤ 2/3: è¯·æ±‚æ‘„åƒå¤´...<br><span style='font-size:14px; color:#f00'>è¯·åœ¨ä¸Šæ–¹å¼¹çª—ç‚¹å‡»â€œå…è®¸â€</span>";
        
        const cameraObj = new Camera(video, {
            onFrame: async () => {
                await hands.send({image: video});
            },
            width: 1280, height: 720
        });

        // 3. å¯åŠ¨
        await cameraObj.start();
        document.getElementById('loading').innerText = "æ­¥éª¤ 3/3: æ­£åœ¨è¯†åˆ«æ‰‹åŠ¿...";
        console.log("æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ");

    } catch (err) {
        logError("å¯åŠ¨å¤±è´¥: " + err.message);
        if(err.message.includes("Permission")) {
            logError("è¯·æ£€æŸ¥æµè§ˆå™¨åœ°å€æ æ˜¯å¦ç¦æ­¢äº†æ‘„åƒå¤´ï¼");
        }
    }
}

startApp();
</script>
</body>
</html>
